{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container">
    <!-- Account Details -->
    <div class="row">
        <div class="col-12">
            <h3>Account Details</h3>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Full Name:</strong> {{ user.get_full_name }}</p>
            <p><strong>Dietary Preference:</strong> 
                {% if profile.dietary_preference == "plant_based" %}
                    {{ profile.get_dietary_preference_display }}
                {% else %}
                    None
                {% endif %}
            </p>
            <p><strong>Allergen Preferences:</strong> 
                {% for field_name, label in form.ALLERGEN_FIELDS %}
                    {% if profile|get_attr:field_name %}
                        {{ label }}{% if not forloop.last %}, {% endif %}
                    {% endif %}
                {% endfor %}
            </p>
            <p><strong>Newsletter:</strong> {{ profile.newsletter_recipient|yesno:"Subscribed,Not Subscribed" }}</p>
        </div>
    </div>

    <!-- Latest Order Details -->
    {% if latest_order %}
    <div class="row mt-4">
        <div class="col-12">
            <h3>Latest Order</h3>
            <p><strong>Order Number:</strong> {{ latest_order.order_number }}</p>
            <p><strong>Date:</strong> {{ latest_order.date }}</p>
            <p><strong>Dispatched:</strong> {{ latest_order.dispatched|yesno:"Yes,No" }}</p>
            <h4>Items:</h4>
            <ul>
                {% for item in latest_order.lineitems.all %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <h3>Subscription Status</h3>
            {% if user.profile.is_subscribed %}
                <p>You are a subscriber!</p>
                <p>Subscription Start Date: {{ user.profile.subscription_start_date }}</p>
                <p>Time Remaining: {{ user.profile.get_subscription_time_remaining.time_remaining }}</p>
                {% if user.profile.get_subscription_time_remaining.expired %}
                    <p>Your subscription has expired.</p>
                {% endif %}
            {% else %}
                <p>You do not have an active subscription.</p>
                <a href="{% url 'profiles:subscription_page' %}" class="btn btn-primary" {% if user.profile.get_subscription_time_remaining.expired %}disabled{% endif %}>Subscribe Now</a>
            {% endif %}
        </div>
    </div>

    <!-- Order History -->
    <div class="row mt-4">
        <div class="col-12">
            <h3>Order History</h3>
            <ul>
                {% for order in orders %}
                <li>
                    <a href="{% url 'profiles:order_detail' order.pk %}">Order #{{ order.order_number }} - {{ order.date }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}